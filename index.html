<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>WorkTime Tracker v5.1</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorkTime">
    <meta name="theme-color" content="#171717">
    
    <!-- App Icon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23171717'/%3E%3Ccircle cx='50' cy='50' r='38' fill='none' stroke='%2338bdf8' stroke-width='8'/%3E%3Cpath d='M50 25 V 50 H 70' fill='none' stroke='%23f8fafc' stroke-width='8' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%23171717'/%3E%3Ccircle cx='90' cy='90' r='68' fill='none' stroke='%2338bdf8' stroke-width='12'/%3E%3Cpath d='M90 45 V 90 H 125' fill='none' stroke='%23f8fafc' stroke-width='12' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <link rel="manifest" id="manifest">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        html { font-family: 'Inter', sans-serif; }
        body {
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }
        .timer-glow {
            box-shadow: 0 0 40px 0 rgba(56, 189, 248, 0.4);
        }
        .modal-backdrop-custom {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .entry-list::-webkit-scrollbar { display: none; }
        .entry-list { -ms-overflow-style: none; scrollbar-width: none; }
        .user-btn.timer-running::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background-color: #22c55e; /* green-500 */
            border-radius: 50%;
            border: 1px solid #171717;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-neutral-900 text-slate-50 antialiased overflow-hidden h-screen transition-colors duration-300">
    <div id="app-container" class="relative h-full w-full max-w-lg mx-auto flex flex-col transition-all duration-300">
        
        <!-- Header -->
        <header class="px-4 pt-4 pb-2 flex justify-between items-center">
            <div>
                <h1 id="greeting" class="text-2xl font-bold text-slate-200"></h1>
                <p class="text-sm text-sky-400 font-medium">Přehled dnešního dne</p>
            </div>
            <div id="user-switcher" class="flex items-center bg-neutral-800 rounded-full p-1 space-x-1"></div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col px-4 overflow-hidden">
            <!-- Timer Card -->
            <div id="timer-card" class="relative flex flex-col items-center justify-center bg-neutral-800/50 rounded-3xl p-6 my-4 transition-all duration-300">
                <div class="relative w-52 h-52">
                    <svg class="absolute inset-0" viewBox="0 0 100 100">
                        <circle class="text-neutral-700/50" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/>
                        <circle id="progress-circle" class="text-sky-400 transition-all duration-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" style="transform: rotate(-90deg); transform-origin: 50% 50%;" stroke-dasharray="283" stroke-dashoffset="283"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <h2 id="timer-display" class="text-5xl font-extrabold tracking-tighter text-slate-50">00:00</h2>
                        <p id="timer-seconds" class="text-2xl font-bold text-neutral-500 -mt-2">00</p>
                        <p id="live-earnings" class="text-lg font-semibold text-green-400 mt-1"></p>
                    </div>
                </div>
                 <div class="flex items-center gap-3 mt-4">
                    <button id="retro-toggle" class="h-10 px-4 flex items-center justify-center bg-neutral-700 hover:bg-neutral-600 text-slate-300 rounded-full text-sm font-medium transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z" clip-rule="evenodd" /></svg>
                        Zpětně
                    </button>
                    <input type="time" id="retro-start-input" class="hidden h-10 w-28 bg-neutral-900 border border-neutral-700 rounded-full text-center text-slate-200 focus:ring-2 focus:ring-sky-400 focus:outline-none">
                    <button id="start-stop-btn" class="relative w-40 h-14 rounded-full text-lg font-bold transition-all duration-300 overflow-hidden">
                        <span class="absolute inset-0 flex items-center justify-center">Start</span>
                    </button>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-slate-200">Historie</h3>
                    <div id="view-switcher" class="flex items-center bg-neutral-800 rounded-full p-1 text-sm"></div>
                </div>
                <ul id="entry-list" class="space-y-3 overflow-y-auto pb-24">
                    <!-- Entries will be rendered here -->
                </ul>
            </div>
        </main>

        <!-- Footer Navigation -->
        <footer class="absolute bottom-0 left-0 right-0 bg-neutral-800/50 backdrop-blur-lg border-t border-neutral-700/50" style="padding-bottom: var(--safe-area-bottom);">
            <nav class="flex justify-around items-center h-16 max-w-lg mx-auto">
                <button id="manual-entry-btn" class="flex flex-col items-center text-neutral-400 hover:text-sky-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    <span class="text-xs font-medium">Přidat</span>
                </button>
                <button id="export-btn" class="flex flex-col items-center text-neutral-400 hover:text-sky-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    <span class="text-xs font-medium">Export</span>
                </button>
                 <button id="settings-btn" class="flex flex-col items-center text-neutral-400 hover:text-sky-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span class="text-xs font-medium">Nastavení</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop-custom bg-black/50 hidden">
        <!-- Modal content will be injected here -->
    </div>
    
    <script>
        // --- CONFIG & STATE ---
        const USERS = ['Marty', 'Čenda', 'Kuba'];
        const DB_KEY = 'workTimeTrackerData_v5.1';
        let state = {};
        let modalResolver = null;
        let globalTickInterval = null;

        // --- ICONS (SVG) ---
        const deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
        const noEntriesIcon = `<svg class="w-16 h-16 text-neutral-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`;

        // --- DOM ELEMENTS ---
        const elements = {
            appContainer: document.getElementById('app-container'),
            greeting: document.getElementById('greeting'),
            userSwitcher: document.getElementById('user-switcher'),
            timerDisplay: document.getElementById('timer-display'),
            timerSeconds: document.getElementById('timer-seconds'),
            liveEarnings: document.getElementById('live-earnings'),
            startStopBtn: document.getElementById('start-stop-btn'),
            retroToggle: document.getElementById('retro-toggle'),
            retroInput: document.getElementById('retro-start-input'),
            viewSwitcher: document.getElementById('view-switcher'),
            entryList: document.getElementById('entry-list'),
            progressCircle: document.getElementById('progress-circle'),
            modalContainer: document.getElementById('modal-container'),
            settingsBtn: document.getElementById('settings-btn'),
            manualEntryBtn: document.getElementById('manual-entry-btn'),
            exportBtn: document.getElementById('export-btn'),
        };

        // --- INITIALIZATION ---
        function init() {
            loadState();
            setupPWA();
            setupEventListeners();
            setupUserSwitcher();
            updateUI();
            startGlobalTicker();
            Notification.requestPermission();
        }

        // --- STATE MANAGEMENT ---
        function loadState() {
            const saved = JSON.parse(localStorage.getItem(DB_KEY));
            const defaultState = {
                currentUser: USERS[0],
                currentView: 'day',
                users: USERS.reduce((acc, user) => {
                    acc[user] = { 
                        timer: { startTime: null }, 
                        entries: [], 
                        settings: { rate: 250, dailyGoal: 8 } 
                    };
                    return acc;
                }, {}),
            };
            state = deepMerge(defaultState, saved || {});
        }
        
        function deepMerge(target, source) {
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    target[key] = deepMerge(target[key] || {}, source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }

        function saveState() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        }

        // --- PWA SETUP ---
        function setupPWA() {
            const manifest = {
                "name": "WorkTime Tracker", "short_name": "WorkTime", "start_url": ".",
                "display": "standalone", "background_color": "#171717", "theme_color": "#38bdf8",
                "icons": [{"src": document.querySelector('link[rel="apple-touch-icon"]').href, "sizes": "180x180", "type": "image/svg+xml"}]
            };
            document.getElementById('manifest').href = `data:application/manifest+json,${encodeURIComponent(JSON.stringify(manifest))}`;

            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'worktime-v5.1';
                    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME)));
                    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(res => res || fetch(e.request))));
                    self.addEventListener('activate', e => e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))))));
                `;
                navigator.serviceWorker.register(`data:application/javascript,${encodeURIComponent(swCode)}`).catch(console.error);
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            elements.userSwitcher.addEventListener('click', handleUserSwitch);
            elements.startStopBtn.addEventListener('click', handleStartStop);
            elements.retroToggle.addEventListener('click', toggleRetroInput);
            elements.viewSwitcher.addEventListener('click', handleViewSwitch);
            elements.entryList.addEventListener('click', handleDeleteClick);
            elements.settingsBtn.addEventListener('click', openSettings);
            elements.manualEntryBtn.addEventListener('click', openManualEntry);
            elements.exportBtn.addEventListener('click', exportToCSV);
        }

        // --- HANDLERS ---
        function handleUserSwitch(e) {
            const btn = e.target.closest('.user-btn');
            if (!btn) return;

            vibrate();
            const newUser = btn.dataset.user;
            if (state.currentUser === newUser) return;

            state.currentUser = newUser;
            updateUI(); // Update main view for the new user
            saveState();
        }

        function handleViewSwitch(e) {
            const btn = e.target.closest('.view-btn');
            if (btn) {
                vibrate();
                state.currentView = btn.dataset.view;
                updateUI();
            }
        }

        function handleStartStop() {
            vibrate(100);
            getUserTimer().startTime ? stopTimer() : startTimer();
        }

        function toggleRetroInput() {
            vibrate();
            const isVisible = !elements.retroInput.classList.contains('hidden');
            elements.retroInput.classList.toggle('hidden', isVisible);
            elements.retroToggle.classList.toggle('bg-sky-500', !isVisible);
            elements.retroToggle.classList.toggle('text-white', !isVisible);
        }

        async function handleDeleteClick(e) {
            const btn = e.target.closest('.delete-btn');
            if (btn) {
                vibrate();
                const id = btn.dataset.id;
                const confirmed = await showModal({
                    title: 'Smazat záznam?',
                    message: 'Tato akce je nevratná a záznam bude trvale odstraněn.',
                    confirmText: 'Smazat',
                    confirmClass: 'bg-red-600 hover:bg-red-700',
                });
                if (confirmed) {
                    getUserData().entries = getUserData().entries.filter(e => e.id !== id);
                    saveState();
                    updateUI();
                }
            }
        }
        
        // --- TIMER LOGIC ---
        const getUserData = (user = state.currentUser) => state.users[user];
        const getUserTimer = (user = state.currentUser) => getUserData(user).timer;
        const getUserSettings = (user = state.currentUser) => getUserData(user).settings;

        function startGlobalTicker() {
            if (globalTickInterval) clearInterval(globalTickInterval);
            globalTickInterval = setInterval(() => {
                // Update display only for the current user
                updateTimerDisplay();
                // Update indicators for all users
                updateUserSwitcherIndicators();
            }, 1000);
        }

        function startTimer() {
            let startTime = Date.now();
            if (!elements.retroInput.classList.contains('hidden') && elements.retroInput.value) {
                const [h, m] = elements.retroInput.value.split(':').map(Number);
                const retro = new Date();
                retro.setHours(h, m, 0, 0);
                if (retro > new Date()) retro.setDate(retro.getDate() - 1);
                startTime = retro.getTime();
            }
            getUserTimer().startTime = startTime;
            updateTimerButton(true);
            saveState();
        }

        function stopTimer() {
            const timer = getUserTimer();
            if (!timer.startTime) return;
            const endTime = Date.now();
            
            addEntry(timer.startTime, endTime);
            
            timer.startTime = null;
            
            elements.retroInput.value = '';
            elements.retroInput.classList.add('hidden');
            elements.retroToggle.classList.remove('bg-sky-500', 'text-white');
            
            updateTimerButton(false);
            updateTimerDisplay(); // Reset display to 0
            
            saveState();
            updateUI();
            notify(`Čas zastaven: ${formatDuration(endTime - timer.startTime, 'hm')}`);
        }

        function addEntry(start, end) {
            const duration = end - start;
            if (duration < 1000) return; // Don't save entries less than a second
            getUserData().entries.push({ id: `entry_${Date.now()}`, start, end, duration });
        }

        // --- UI UPDATES ---
        function updateUI() {
            updateGreeting();
            updateActiveUserButton();
            updateViewSwitcher();
            renderEntries();
            updateTimerDisplay();
            updateTimerButton(!!getUserTimer().startTime);
        }

        function setupUserSwitcher() {
            elements.userSwitcher.innerHTML = USERS.map(user => `
                <button class="user-btn relative px-3 py-1.5 text-sm font-semibold rounded-full transition-colors" data-user="${user}">
                    ${user.charAt(0)}
                </button>
            `).join('');
        }

        function updateUserSwitcherIndicators() {
            elements.userSwitcher.querySelectorAll('.user-btn').forEach(btn => {
                const user = btn.dataset.user;
                const isRunning = !!getUserTimer(user).startTime;
                btn.classList.toggle('timer-running', isRunning);
            });
        }

        function updateActiveUserButton() {
             elements.userSwitcher.querySelectorAll('.user-btn').forEach(btn => {
                const isCurrentUser = btn.dataset.user === state.currentUser;
                btn.classList.toggle('bg-sky-500', isCurrentUser);
                btn.classList.toggle('text-white', isCurrentUser);
                btn.classList.toggle('text-neutral-400', !isCurrentUser);
                btn.classList.toggle('hover:bg-neutral-700', !isCurrentUser);
            });
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Dobré ráno' : hour < 18 ? 'Dobrý den' : 'Dobrý večer';
            elements.greeting.textContent = `${greeting}, ${state.currentUser}`;
        }
        
        function updateViewSwitcher() {
            const views = { day: 'Den', week: 'Týden', month: 'Měsíc' };
            elements.viewSwitcher.innerHTML = Object.entries(views).map(([key, label]) => `
                <button class="view-btn px-3 py-1 rounded-full ${state.currentView === key ? 'bg-sky-500 text-white' : 'text-neutral-400'}" data-view="${key}">
                    ${label}
                </button>
            `).join('');
        }

        function updateTimerButton(isRunning) {
            const btn = elements.startStopBtn;
            btn.className = `relative w-40 h-14 rounded-full text-lg font-bold transition-all duration-300 overflow-hidden ${isRunning ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-green-500 hover:bg-green-600 text-white'}`;
            btn.firstElementChild.textContent = isRunning ? 'Stop' : 'Start';
            elements.liveEarnings.style.display = isRunning ? 'block' : 'none';
            elements.retroToggle.style.display = isRunning ? 'none' : 'flex';
            elements.appContainer.classList.toggle('timer-glow', isRunning);
        }

        function updateTimerDisplay() {
            const timer = getUserTimer();
            const elapsed = timer.startTime ? Date.now() - timer.startTime : 0;
            
            const totalSeconds = Math.floor(elapsed / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            elements.timerDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            elements.timerSeconds.textContent = String(seconds).padStart(2, '0');

            if (timer.startTime) {
                const elapsedHours = elapsed / 3600000;
                const earnings = elapsedHours * getUserSettings().rate;
                elements.liveEarnings.textContent = `${formatCurrency(earnings)}`;
                
                const goal = getUserSettings().dailyGoal;
                const progress = goal > 0 ? Math.min(elapsedHours / goal, 1) : 0;
                elements.progressCircle.style.strokeDashoffset = 283 * (1 - progress);
            } else {
                elements.liveEarnings.textContent = '';
                elements.progressCircle.style.strokeDashoffset = 283;
            }
        }

        function renderEntries() {
            const entries = getFilteredEntries();
            if (!entries.length) {
                elements.entryList.innerHTML = `
                    <li class="flex flex-col items-center justify-center text-center text-neutral-600 pt-10">
                        ${noEntriesIcon}
                        <p class="mt-4 font-medium">Žádné záznamy</p>
                        <p class="text-sm">Pro tento pohled nebyly nalezeny žádné záznamy.</p>
                    </li>`;
                return;
            }

            elements.entryList.innerHTML = entries.map(entry => `
                <li class="flex items-center bg-neutral-800 p-4 rounded-2xl">
                    <div class="flex-1">
                        <p class="font-semibold text-slate-200">${formatDate(entry.start)}</p>
                        <p class="text-sm text-neutral-400">${formatTime(entry.start)} - ${formatTime(entry.end)}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-sky-400">${formatDuration(entry.duration, 'hm')}</p>
                        <p class="text-sm font-medium text-green-400">${formatCurrency((entry.duration / 3600000) * getUserSettings().rate)}</p>
                    </div>
                    <button class="delete-btn ml-4 text-neutral-500 hover:text-red-500 transition-colors" data-id="${entry.id}" aria-label="Smazat">${deleteIcon}</button>
                </li>
            `).join('');
        }

        // --- MODALS ---
        async function showModal({ title, message, confirmText, cancelText = 'Zrušit', confirmClass = 'bg-sky-500', inputs = [] }) {
            return new Promise(resolve => {
                modalResolver = resolve;
                let inputsHtml = inputs.map(input => `
                    <div class="mb-4">
                        <label for="${input.id}" class="block text-sm font-medium text-neutral-400 mb-1">${input.label}</label>
                        <input type="${input.type || 'text'}" id="${input.id}" value="${input.value || ''}" placeholder="${input.placeholder || ''}" class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-slate-200 focus:ring-2 focus:ring-sky-400 focus:outline-none">
                    </div>
                `).join('');

                elements.modalContainer.innerHTML = `
                    <div class="bg-neutral-800 w-full max-w-sm rounded-2xl shadow-lg p-6 transform transition-all scale-95 opacity-0" id="modal-content">
                        <h2 class="text-xl font-bold text-slate-100">${title}</h2>
                        ${message ? `<p class="text-neutral-400 mt-2">${message}</p>` : ''}
                        <div class="mt-6">${inputsHtml}</div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button id="modal-cancel" class="px-4 py-2 rounded-lg bg-neutral-700 hover:bg-neutral-600 text-slate-200 font-semibold transition-colors">${cancelText}</button>
                            <button id="modal-confirm" class="px-4 py-2 rounded-lg text-white font-semibold transition-colors ${confirmClass}">${confirmText}</button>
                        </div>
                    </div>
                `;
                elements.modalContainer.classList.remove('hidden');
                setTimeout(() => document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0'), 10);
                
                document.getElementById('modal-confirm').onclick = () => {
                    const values = inputs.reduce((acc, input) => {
                        acc[input.id] = document.getElementById(input.id).value;
                        return acc;
                    }, {});
                    closeModal(inputs.length > 0 ? values : true);
                };
                document.getElementById('modal-cancel').onclick = () => closeModal(false);
            });
        }

        function closeModal(value) {
            const content = document.getElementById('modal-content');
            if(content) content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                elements.modalContainer.classList.add('hidden');
                elements.modalContainer.innerHTML = '';
                if (modalResolver) modalResolver(value);
                modalResolver = null;
            }, 200);
        }

        async function openSettings() {
            vibrate();
            const settings = getUserSettings();
            const result = await showModal({
                title: 'Nastavení',
                confirmText: 'Uložit',
                inputs: [
                    { id: 'rate', label: 'Hodinová sazba (Kč)', value: settings.rate, type: 'number', placeholder: '250' },
                    { id: 'dailyGoal', label: 'Denní cíl (hodiny)', value: settings.dailyGoal, type: 'number', placeholder: '8' }
                ]
            });
            if (result) {
                const rate = parseFloat(result.rate);
                const goal = parseFloat(result.dailyGoal);
                if (rate > 0 && goal >= 0) {
                    settings.rate = rate;
                    settings.dailyGoal = goal;
                    saveState();
                    updateUI();
                }
            }
        }

        async function openManualEntry() {
            vibrate();
            const result = await showModal({
                title: 'Ruční zadání',
                confirmText: 'Uložit',
                inputs: [
                    { id: 'manualDate', label: 'Datum', type: 'date', value: new Date().toISOString().split('T')[0] },
                    { id: 'manualDuration', label: 'Doba (např. 2:30, 90m, 1.5h)', placeholder: '2:30' }
                ]
            });
            if (result && result.manualDate && result.manualDuration) {
                const durationMs = parseDuration(result.manualDuration);
                if (durationMs <= 0) return;
                const end = new Date(`${result.manualDate}T23:59:59`).getTime();
                const start = end - durationMs;
                addEntry(start, end);
                saveState();
                updateUI();
            }
        }

        // --- UTILITIES ---
        function getFilteredEntries() {
            const now = new Date();
            const startOf = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate());
            let startDate;
            
            if (state.currentView === 'day') {
                startDate = startOf(now);
            } else if (state.currentView === 'week') {
                const dayOfWeek = now.getDay();
                const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Sunday
                startDate = startOf(new Date(now.setDate(diff)));
            } else if (state.currentView === 'month') {
                startDate = startOf(new Date(now.getFullYear(), now.getMonth(), 1));
            }
            return getUserData().entries.filter(e => e.start >= startDate.getTime()).sort((a,b) => b.start - a.start);
        }

        function parseDuration(str) {
            if (!str) return 0;
            let minutes = 0;
            if (str.includes(':')) {
                const [h, m] = str.split(':').map(Number);
                minutes = (h || 0) * 60 + (m || 0);
            } else if (str.toLowerCase().includes('h')) {
                minutes = parseFloat(str) * 60;
            } else if (str.toLowerCase().includes('m')) {
                minutes = parseFloat(str);
            } else if (!isNaN(parseFloat(str))) {
                minutes = parseFloat(str); // Assume minutes if no unit
            }
            return minutes * 60000;
        }

        function formatDuration(ms, format = 'hms') {
            const s = Math.floor(ms / 1000);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            if (format === 'hm') return `${h}h ${String(m).padStart(2,'0')}m`;
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s % 60).padStart(2,'0')}`;
        }

        function formatDate(ts) { return new Date(ts).toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'long' }); }
        function formatTime(ts) { return new Date(ts).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' }); }
        function formatCurrency(amount) { return amount.toLocaleString('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 }); }

        function exportToCSV() {
            vibrate();
            const entries = getUserData().entries;
            if (!entries.length) return;
            let csv = 'Datum;Začátek;Konec;Doba (min);Sazba;Výdělek\r\n';
            entries.forEach(e => {
                const hours = e.duration / 3600000;
                const earn = hours * getUserSettings().rate;
                csv += `${new Date(e.start).toLocaleDateString('cs-CZ')};${formatTime(e.start)};${formatTime(e.end)};${Math.round(e.duration / 60000)};${getUserSettings().rate};${earn.toFixed(2).replace('.', ',')}\r\n`;
            });
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = `export_${state.currentUser}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function vibrate(ms = 10) { navigator.vibrate?.(ms); }
        function notify(message) {
            if (Notification.permission === 'granted') new Notification('WorkTime Tracker', { body: message, icon: document.querySelector('link[rel="icon"]').href });
        }

        // --- START APP ---
        init();
    </script>
</body>
</html>
