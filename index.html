<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>WorkTime Tracker v4.0</title>

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorkTime">
    <meta name="theme-color" content="#0A0F1A">
    
    <!-- Nová Ikona Aplikace (Working Timer Style) -->
    <link rel="icon" href="image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230A0F1A' stroke='%2358A6FF' stroke-width='5'/%3E%3Cpath d='M50 20 L50 50 L70 60' stroke='%2358A6FF' stroke-width='5' stroke-linecap='round'/%3E%3Ccircle cx='50' cy='50' r='5' fill='%2358A6FF'/%3E%3Ctext x='50' y='90' font-size='20' fill='%2358A6FF' text-anchor='middle' font-family='Roboto Mono,monospace'%3EWT%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%230A0F1A'/%3E%3Ccircle cx='90' cy='90' r='70' fill='none' stroke='%2358A6FF' stroke-width='10'/%3E%3Cpath d='M90 40 L90 90 L130 110' stroke='%2358A6FF' stroke-width='10' stroke-linecap='round'/%3E%3Ccircle cx='90' cy='90' r='8' fill='%2358A6FF'/%3E%3C/svg%3E">
    <link rel="manifest" id="manifest">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0A0F1A;
            --card: rgba(22, 27, 34, 0.85);
            --text: #E6EDF3;
            --text-secondary: #8B949E;
            --primary: #58A6FF;
            --accent: #39D353;
            --danger: #F85149;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
            --neumorph: inset 4px 4px 8px rgba(0,0,0,0.2), inset -4px -4px 8px rgba(255,255,255,0.05);
            --glow: 0 0 12px var(--primary);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        body.light-mode {
            --bg: #F0F6FC;
            --card: rgba(255,255,255,0.9);
            --text: #0D1117;
            --text-secondary: #656D76;
            --primary: #1F6FEB;
            --accent: #238636;
            --danger: #CF222E;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
            --neumorph: inset 4px 4px 8px rgba(0,0,0,0.05), inset -4px -4px 8px rgba(255,255,255,0.2);
            --glow: none;
        }

        html { box-sizing: border-box; font-family: 'Roboto Mono', monospace; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            padding: var(--safe-area-top) 0 var(--safe-area-bottom) 0;
            overflow: hidden; height: 100vh; transition: all 0.3s ease;
        }

        .background-gradient {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--bg) 100%);
            opacity: 0.1; z-index: -1;
        }

        .app-container {
            display: flex; flex-direction: column; height: 100vh;
            max-width: 600px; margin: 0 auto; padding: 20px;
        }

        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .greeting { font-size: 1.3rem; font-weight: 700; text-shadow: var(--glow); }

        .user-switcher { display: flex; background: var(--card); padding: 4px; border-radius: 50px; box-shadow: var(--neumorph); }
        .user-btn { padding: 8px 16px; border-radius: 50px; background: none; border: none; color: var(--text); font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .user-btn.active { background: linear-gradient(45deg, var(--primary), var(--accent)); color: #fff; box-shadow: var(--glow); }

        .header-icon-btn { background: var(--card); border: none; padding: 8px; border-radius: 50%; box-shadow: var(--neumorph); cursor: pointer; transition: all 0.3s; }
        .header-icon-btn:hover { box-shadow: var(--glow); transform: scale(1.1); }
        .header-icon-btn svg { width: 24px; height: 24px; fill: var(--text-secondary); }

        .timer-card { position: relative; background: var(--card); border-radius: 24px; padding: 32px; text-align: center; box-shadow: var(--shadow), var(--neumorph); margin-bottom: 24px; backdrop-filter: blur(12px); }
        .progress-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; }
        .progress-ring circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }

        .timer-display { font-size: 4rem; font-weight: 700; text-shadow: var(--glow); position: relative; z-index: 1; }
        .live-earnings { font-size: 1.4rem; color: var(--accent); font-weight: 700; margin: 8px 0; text-shadow: var(--glow); }

        .timer-controls { display: flex; justify-content: center; gap: 16px; align-items: center; }
        .timer-btn { padding: 16px 32px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow); color: #fff; }
        .start-btn { background: linear-gradient(45deg, var(--accent), #1f9a55); }
        .stop-btn { background: linear-gradient(45deg, var(--danger), #c43e37); }
        .retro-btn { background: var(--primary); padding: 8px 16px; border-radius: 50px; font-size: 0.9rem; }

        .retro-input { display: none; padding: 12px; border-radius: 12px; border: 1px solid var(--primary); background: var(--bg); color: var(--text); width: 120px; }

        .stats-container { flex-grow: 1; overflow-y: auto; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .stats-title { font-size: 1.2rem; font-weight: 700; }

        .view-switcher { display: flex; background: var(--card); padding: 4px; border-radius: 50px; box-shadow: var(--neumorph); }
        .view-btn { padding: 6px 12px; border-radius: 50px; background: none; border: none; color: var(--text-secondary); font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .view-btn.active { background: var(--primary); color: #fff; box-shadow: var(--glow); }

        .summary-card { display: flex; justify-content: space-around; background: var(--card); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px; }
        .summary-item { text-align: center; }
        .summary-item h3 { font-size: 0.9rem; color: var(--text-secondary); }
        .summary-item p { font-size: 1.8rem; font-weight: 700; }

        .entry-list { list-style: none; padding: 0; }
        .entry-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--card); border-radius: 16px; margin-bottom: 12px; box-shadow: var(--neumorph); transition: all 0.3s; }
        .entry-item:hover { box-shadow: var(--glow); }
        .entry-details { flex-grow: 1; }
        .entry-date { font-weight: 700; }
        .entry-time { font-size: 0.9rem; color: var(--text-secondary); }
        .entry-duration { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .delete-btn { background: none; border: none; cursor: pointer; }

        .app-footer { display: flex; justify-content: center; gap: 16px; padding: 20px 0; }
        .footer-btn { padding: 10px 20px; border-radius: 50px; background: var(--primary); color: #fff; border: none; font-weight: 700; cursor: pointer; box-shadow: var(--shadow); transition: all 0.3s; }
        .footer-btn:hover { box-shadow: var(--glow); transform: scale(1.05); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: var(--card); padding: 24px; border-radius: 24px; width: 90%; max-width: 400px; box-shadow: var(--shadow); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .modal-btn { padding: 10px 20px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; }
        .modal-btn.primary { background: var(--primary); color: #fff; }
        .modal-btn.secondary { background: var(--text-secondary); color: var(--text); }
        .modal-input-group { margin-bottom: 16px; }
        .modal-input-group label { display: block; margin-bottom: 4px; color: var(--text-secondary); }
        .modal-input-group input { width: 100%; padding: 10px; border-radius: 12px; border: 1px solid var(--primary); background: var(--bg); color: var(--text); }
    </style>
</head>
<body>
    <div class="background-gradient"></div>
    <div class="app-container">
        <header class="app-header">
            <h1 class="greeting" id="greeting"></h1>
            <div class="header-controls" style="display: flex; gap: 8px;">
                <div class="user-switcher" id="user-switcher"></div>
                <button class="header-icon-btn" id="settings-btn" aria-label="Nastavení"></button>
                <button class="header-icon-btn" id="theme-switcher" aria-label="Přepnout motiv"></button>
            </div>
        </header>

        <main>
            <div class="timer-card">
                <svg class="progress-ring" viewBox="0 0 200 200">
                    <circle cx="100" cy="100" r="90" fill="transparent" stroke="rgba(88,166,255,0.2)" stroke-width="10"/>
                    <circle id="progress-circle" cx="100" cy="100" r="90" fill="transparent" stroke="var(--accent)" stroke-width="10" stroke-dasharray="565" stroke-dashoffset="565"/>
                </svg>
                <h2 class="timer-display" id="timer-display">00:00:00</h2>
                <p class="live-earnings" id="live-earnings"></p>
                <div class="timer-controls">
                    <button class="timer-btn retro-btn" id="retro-toggle">Zpětný Start</button>
                    <input type="time" id="retro-start-input" class="retro-input">
                    <button class="timer-btn start-btn" id="start-stop-btn">Start</button>
                </div>
            </div>

            <div class="stats-container">
                <div class="stats-header">
                    <h2 class="stats-title">Přehled</h2>
                    <div class="view-switcher" id="view-switcher">
                        <button class="view-btn active" data-view="day">Den</button>
                        <button class="view-btn" data-view="week">Týden</button>
                        <button class="view-btn" data-view="month">Měsíc</button>
                    </div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-item"><h3>Odpracováno</h3><p id="summary-time">0h 0m</p></div>
                    <div class="summary-item"><h3>Výdělek</h3><p id="summary-earnings">0 Kč</p></div>
                    <div class="summary-item"><h3>Průměr/den</h3><p id="summary-average">0 Kč</p></div>
                </div>

                <ul class="entry-list" id="entry-list"></ul>
            </div>
        </main>
        
        <footer class="app-footer">
            <button class="footer-btn" id="manual-entry-btn">Přidat ručně</button>
            <button class="footer-btn" id="export-btn">Exportovat (CSV)</button>
            <button class="footer-btn" id="backup-btn">Záloha (JSON)</button>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Nastavení</h2>
            <div class="modal-input-group">
                <label for="hourly-rate-input">Hodinová sazba (Kč)</label>
                <input type="number" id="hourly-rate-input" placeholder="250">
            </div>
            <div class="modal-input-group">
                <label for="daily-goal-input">Denní cíl (hodiny)</label>
                <input type="number" step="0.5" id="daily-goal-input" placeholder="8">
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="settings-cancel">Zrušit</button>
                <button class="modal-btn primary" id="settings-save">Uložit</button>
            </div>
        </div>
    </div>
    <div id="manual-entry-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Ruční zadání</h2>
            <form id="manual-entry-form">
                <div class="modal-input-group">
                    <label for="manual-date">Datum</label>
                    <input type="date" id="manual-date" required>
                </div>
                <div class="modal-input-group">
                    <label for="manual-duration">Doba (např. 2:30, 90m)</label>
                    <input type="text" id="manual-duration" placeholder="2:30" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="modal-btn secondary" id="manual-cancel">Zrušit</button>
                    <button type="submit" class="modal-btn primary">Uložit</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Smazat záznam?</h2>
            <p>Tato akce je nevratná.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="delete-cancel">Zrušit</button>
                <button class="modal-btn primary" id="delete-confirm" style="background: var(--danger);">Smazat</button>
            </div>
        </div>
    </div>
    
    <script>
        const USERS = ['Marty', 'Čenda', 'Kuba'];
        const DB_KEY = 'workTimeTrackerData_v4.0';
        let state = {};
        let deleteResolver = null;

        // Icons (SVG)
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/></svg>`;
        const settingsIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.446.367.533.98.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`;
        const deleteIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>`;

        // DOM Elements
        const elements = {
            greeting: document.getElementById('greeting'),
            userSwitcher: document.getElementById('user-switcher'),
            themeSwitcher: document.getElementById('theme-switcher'),
            settingsBtn: document.getElementById('settings-btn'),
            timerDisplay: document.getElementById('timer-display'),
            liveEarnings: document.getElementById('live-earnings'),
            startStopBtn: document.getElementById('start-stop-btn'),
            retroToggle: document.getElementById('retro-toggle'),
            retroInput: document.getElementById('retro-start-input'),
            viewSwitcher: document.getElementById('view-switcher'),
            summaryTime: document.getElementById('summary-time'),
            summaryEarnings: document.getElementById('summary-earnings'),
            summaryAverage: document.getElementById('summary-average'),
            entryList: document.getElementById('entry-list'),
            exportBtn: document.getElementById('export-btn'),
            backupBtn: document.getElementById('backup-btn'),
            manualEntryBtn: document.getElementById('manual-entry-btn'),
            progressCircle: document.getElementById('progress-circle'),
            settingsModal: document.getElementById('settings-modal'),
            manualModal: document.getElementById('manual-entry-modal'),
            deleteModal: document.getElementById('confirm-delete-modal')
        };

        // Init
        function init() {
            loadState();
            setupPWA();
            setupEventListeners();
            setupUserSwitcher();
            updateUI();
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        // State Management
        function loadState() {
            const saved = JSON.parse(localStorage.getItem(DB_KEY));
            const defaultState = {
                currentUser: USERS[0],
                currentView: 'day',
                users: USERS.reduce((acc, user) => {
                    acc[user] = { timer: { startTime: null, intervalId: null }, entries: [], settings: { rate: 250, dailyGoal: 8 } };
                    return acc;
                }, {}),
                globalSettings: { theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' }
            };
            state = { ...defaultState, ...safeMerge(saved, defaultState) };
            resumeUserTimer();
        }

        function safeMerge(saved, defaultObj) {
            if (!saved) return {};
            const merged = {};
            for (const key in defaultObj) {
                merged[key] = typeof saved[key] === 'object' ? safeMerge(saved[key], defaultObj[key]) : (saved[key] ?? defaultObj[key]);
            }
            return merged;
        }

        function saveState() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
        }

        // PWA Setup
        function setupPWA() {
            const manifest = {
                "name": "WorkTime Tracker",
                "short_name": "WorkTime",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#0A0F1A",
                "theme_color": "#58A6FF",
                "icons": [{
                    "src": "image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle cx='256' cy='256' r='230' fill='%230A0F1A' stroke='%2358A6FF' stroke-width='20'/%3E%3Cpath d='M256 100 L256 256 L370 310' stroke='%2358A6FF' stroke-width='30' stroke-linecap='round'/%3E%3Ccircle cx='256' cy='256' r='20' fill='%2358A6FF'/%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }]
            };
            document.getElementById('manifest').href = `application/manifest+json,${encodeURIComponent(JSON.stringify(manifest))}`;

            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'worktime-v4.0';
                    self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['/']))));
                    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(res => res || fetch(e.request))));
                    self.addEventListener('activate', e => e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))))));
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob));
            }
        }

        // Event Listeners
        function setupEventListeners() {
            elements.userSwitcher.addEventListener('click', handleUserSwitch);
            elements.themeSwitcher.addEventListener('click', toggleTheme);
            elements.startStopBtn.addEventListener('click', handleStartStop);
            elements.retroToggle.addEventListener('click', toggleRetroInput);
            elements.viewSwitcher.addEventListener('click', handleViewSwitch);
            elements.entryList.addEventListener('click', handleDeleteClick);
            elements.exportBtn.addEventListener('click', exportToCSV);
            elements.backupBtn.addEventListener('click', handleBackup);
            elements.settingsBtn.addEventListener('click', openSettings);
            elements.manualEntryBtn.addEventListener('click', openManualEntry);
            document.getElementById('settings-save').addEventListener('click', saveSettings);
            document.getElementById('settings-cancel').addEventListener('click', () => elements.settingsModal.classList.remove('visible'));
            document.getElementById('manual-entry-form').addEventListener('submit', handleManualSubmit);
            document.getElementById('manual-cancel').addEventListener('click', () => elements.manualModal.classList.remove('visible'));
            document.getElementById('delete-confirm').addEventListener('click', () => { deleteResolver?.(true); });
            document.getElementById('delete-cancel').addEventListener('click', () => { deleteResolver?.(false); });
        }

        function setupUserSwitcher() {
            elements.userSwitcher.innerHTML = USERS.map(user => `<button class="user-btn" data-user="${user}">${user}</button>`).join('');
        }

        // Handlers
        function handleUserSwitch(e) {
            const btn = e.target.closest('.user-btn');
            if (btn) {
                vibrate();
                const newUser = btn.dataset.user;
                if (state.currentUser !== newUser && getUserTimer().intervalId) {
                    if (!confirm('Přepnutí uživatele zastaví aktuální timer. Pokračovat?')) return;
                    stopTimer();
                }
                state.currentUser = newUser;
                updateUI();
                saveState();
            }
        }

        function handleViewSwitch(e) {
            const btn = e.target.closest('.view-btn');
            if (btn) {
                vibrate();
                state.currentView = btn.dataset.view;
                updateUI();
            }
        }

        function handleStartStop() {
            vibrate(100);
            const timer = getUserTimer();
            if (timer.intervalId) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function toggleRetroInput() {
            vibrate();
            const isVisible = elements.retroInput.style.display === 'block';
            elements.retroInput.style.display = isVisible ? 'none' : 'block';
            elements.retroToggle.textContent = isVisible ? 'Zpětný Start' : 'Zrušit Zpětný';
        }

        function handleManualSubmit(e) {
            e.preventDefault();
            vibrate();
            const date = document.getElementById('manual-date').value;
            const durationStr = document.getElementById('manual-duration').value;
            const durationMs = parseDuration(durationStr);
            if (durationMs <= 0) return alert('Neplatná doba.');
            const end = new Date(`${date}T23:59:59`).getTime();
            const start = end - durationMs;
            addEntry(start, end);
            elements.manualModal.classList.remove('visible');
            updateUI();
        }

        async function handleDeleteClick(e) {
            const btn = e.target.closest('.delete-btn');
            if (btn) {
                vibrate();
                const id = btn.dataset.id;
                elements.deleteModal.classList.add('visible');
                const confirmed = await new Promise(res => deleteResolver = res);
                elements.deleteModal.classList.remove('visible');
                if (confirmed) {
                    getUserData().entries = getUserData().entries.filter(e => e.id !== id);
                    saveState();
                    updateUI();
                }
                deleteResolver = null;
            }
        }

        function handleBackup() {
            vibrate();
            const action = confirm('Exportovat (stáhnout) nebo importovat (nahrávat)?') ? 'export' : 'import';
            if (action === 'export') {
                const json = JSON.stringify(state);
                const link = document.createElement('a');
                link.href = `text/json;charset=utf-8,${encodeURIComponent(json)}`;
                link.download = `worktime_backup_${new Date().toISOString()}.json`;
                link.click();
            } else {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = ev => {
                        try {
                            state = JSON.parse(ev.target.result);
                            saveState();
                            updateUI();
                            alert('Data importována úspěšně.');
                        } catch (err) {
                            alert('Chyba při importu.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        }

        function handleVisibilityChange() {
            if (document.hidden && getUserTimer().intervalId) {
                stopTimer(); // Auto-pauza při minimalizaci
                notify('Timer byl pozastaven kvůli nečinnosti.');
            }
        }

        // Timer Logic
        function getUserData() { return state.users[state.currentUser]; }
        function getUserTimer() { return getUserData().timer; }
        function getUserSettings() { return getUserData().settings; }

        function startTimer() {
            let startTime = Date.now();
            if (elements.retroInput.value && elements.retroInput.style.display === 'block') {
                const [h, m] = elements.retroInput.value.split(':').map(Number);
                const retro = new Date();
                retro.setHours(h, m, 0, 0);
                if (retro > new Date()) retro.setDate(retro.getDate() - 1);
                startTime = retro.getTime();
            }
            const timer = getUserTimer();
            timer.startTime = startTime;
            timer.intervalId = setInterval(updateTimer, 1000);
            updateTimerButton(true);
            saveState();
        }

        function resumeUserTimer() {
            const timer = getUserTimer();
            if (timer.startTime) {
                timer.intervalId = setInterval(updateTimer, 1000);
                updateTimerButton(true);
            }
        }

        function stopTimer() {
            const timer = getUserTimer();
            const endTime = Date.now();
            addEntry(timer.startTime, endTime);
            clearInterval(timer.intervalId);
            timer.intervalId = null;
            timer.startTime = null;
            elements.retroInput.value = '';
            elements.retroInput.style.display = 'none';
            elements.retroToggle.textContent = 'Zpětný Start';
            elements.liveEarnings.textContent = '';
            updateTimerButton(false);
            elements.timerDisplay.textContent = '00:00:00';
            elements.progressCircle.style.strokeDashoffset = 565;
            saveState();
            updateUI();
            notify(`Čas zastaven: ${formatDuration(endTime - timer.startTime, 'hm')}`);
        }

        function updateTimer() {
            const timer = getUserTimer();
            if (!timer.startTime) return;
            const elapsed = Date.now() - timer.startTime;
            const hours = elapsed / 3600000;
            const earnings = hours * getUserSettings().rate;
            elements.timerDisplay.textContent = formatDuration(elapsed);
            elements.liveEarnings.textContent = `${earnings.toLocaleString('cs-CZ', {style: 'currency', currency: 'CZK'})}`;
            updateProgress(hours);
        }

        function updateProgress(hours) {
            const goal = getUserSettings().dailyGoal;
            const progress = Math.min(hours / goal, 1);
            elements.progressCircle.style.strokeDashoffset = 565 * (1 - progress);
            if (progress >= 1) notify('Denní cíl dosažen!');
        }

        function addEntry(start, end) {
            const duration = end - start;
            getUserData().entries.push({ id: `entry_${Date.now()}`, start, end, duration });
            saveState();
        }

        // Modals
        function openSettings() {
            vibrate();
            const settings = getUserSettings();
            document.getElementById('hourly-rate-input').value = settings.rate;
            document.getElementById('daily-goal-input').value = settings.dailyGoal;
            elements.settingsModal.classList.add('visible');
        }

        function saveSettings() {
            vibrate();
            const rate = parseFloat(document.getElementById('hourly-rate-input').value);
            const goal = parseFloat(document.getElementById('daily-goal-input').value);
            if (rate > 0 && goal > 0) {
                const settings = getUserSettings();
                settings.rate = rate;
                settings.dailyGoal = goal;
                saveState();
                updateUI();
                elements.settingsModal.classList.remove('visible');
            } else {
                alert('Zadejte platné hodnoty.');
            }
        }

        function openManualEntry() {
            vibrate();
            document.getElementById('manual-date').valueAsDate = new Date();
            elements.manualModal.classList.add('visible');
        }

        // UI Updates
        function updateUI() {
            updateGreeting();
            updateTheme();
            updateActiveUser();
            updateActiveView();
            renderEntries();
            elements.settingsBtn.innerHTML = settingsIcon;
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            const greetings = ['Dobré ráno', 'Dobrý den', 'Dobrý večer', 'Dobrou noc'];
            const index = Math.floor(hour / 6);
            elements.greeting.textContent = `${greetings[index]}, ${state.currentUser}`;
        }

        function updateTheme() {
            document.body.classList.toggle('light-mode', state.globalSettings.theme === 'light');
            elements.themeSwitcher.innerHTML = state.globalSettings.theme === 'light' ? moonIcon : sunIcon;
        }

        function toggleTheme() {
            vibrate();
            state.globalSettings.theme = state.globalSettings.theme === 'light' ? 'dark' : 'light';
            saveState();
            updateTheme();
        }

        function updateActiveUser() {
            [...elements.userSwitcher.querySelectorAll('.user-btn')].forEach(btn => {
                btn.classList.toggle('active', btn.dataset.user === state.currentUser);
            });
        }

        function updateActiveView() {
            [...elements.viewSwitcher.querySelectorAll('.view-btn')].forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === state.currentView);
            });
        }

        function updateTimerButton(isRunning) {
            elements.startStopBtn.textContent = isRunning ? 'Stop' : 'Start';
            elements.startStopBtn.classList.toggle('start-btn', !isRunning);
            elements.startStopBtn.classList.toggle('stop-btn', isRunning);
            elements.liveEarnings.style.display = isRunning ? 'block' : 'none';
            elements.retroToggle.style.display = isRunning ? 'none' : 'block';
        }

        function renderEntries() {
            const entries = getFilteredEntries();
            elements.entryList.innerHTML = entries.length ? entries.map(entry => `
                <li class="entry-item">
                    <div class="entry-details">
                        <span class="entry-date">${formatDate(entry.start)}</span>
                        <span class="entry-time">${formatTime(entry.start)} - ${formatTime(entry.end)}</span>
                    </div>
                    <span class="entry-duration">${formatDuration(entry.duration, 'hm')}</span>
                    <button class="delete-btn" data-id="${entry.id}" aria-label="Smazat">${deleteIcon}</button>
                </li>
            `).join('') : '<p style="text-align: center; color: var(--text-secondary);">Žádné záznamy.</p>';
            updateSummary(entries);
        }

        function updateSummary(entries) {
            const totalMs = entries.reduce((sum, e) => sum + e.duration, 0);
            const days = new Set(entries.map(e => new Date(e.start).toDateString())).size || 1;
            const hours = totalMs / 3600000;
            const earnings = hours * getUserSettings().rate;
            const average = earnings / days;
            elements.summaryTime.textContent = formatDuration(totalMs, 'hm');
            elements.summaryEarnings.textContent = `${earnings.toLocaleString('cs-CZ', {style: 'currency', currency: 'CZK', maximumFractionDigits: 0})}`;
            elements.summaryAverage.textContent = `${average.toLocaleString('cs-CZ', {style: 'currency', currency: 'CZK', maximumFractionDigits: 0})}`;
        }

        // Utilities
        function getFilteredEntries() {
            const now = new Date();
            const startDate = new Date();
            if (state.currentView === 'day') startDate.setHours(0,0,0,0);
            else if (state.currentView === 'week') startDate.setDate(startDate.getDate() - startDate.getDay() + 1);
            else if (state.currentView === 'month') startDate.setDate(1);
            return getUserData().entries.filter(e => new Date(e.start) >= startDate).sort((a,b) => b.start - a.start);
        }

        function parseDuration(str) {
            let minutes = 0;
            if (/:/.test(str)) {
                const [h, m] = str.split(':').map(Number);
                minutes = h * 60 + (m || 0);
            } else if (/h$/.test(str)) minutes = parseFloat(str) * 60;
            else if (/m$/.test(str)) minutes = parseFloat(str);
            else minutes = parseFloat(str) * 60;
            return minutes * 60000;
        }

        function formatDuration(ms, format = 'hms') {
            const s = Math.floor(ms / 1000);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            if (format === 'hm') return `${h}h ${m.toString().padStart(2,'0')}m`;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function formatDate(ts) { return new Date(ts).toLocaleDateString('cs-CZ', {day: 'numeric', month: 'long'}); }
        function formatTime(ts) { return new Date(ts).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'}); }

        function exportToCSV() {
            vibrate();
            const entries = getUserData().entries;
            if (!entries.length) return alert('Není co exportovat.');
            let csv = 'Datum;Začátek;Konec;Doba (min);Sazba;Výdělek\r\n';
            entries.forEach(e => {
                const hours = e.duration / 3600000;
                const earn = hours * getUserSettings().rate;
                csv += `${formatDate(e.start)};${formatTime(e.start)};${formatTime(e.end)};${Math.round(e.duration / 60000)};${getUserSettings().rate};${earn.toFixed(2).replace('.', ',')}\r\n`;
            });
            const link = document.createElement('a');
            link.href = `text/csv;charset=utf-8,${encodeURIComponent(csv)}`;
            link.download = `export_${state.currentUser}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function vibrate(ms = 10) { navigator.vibrate?.(ms); }

        function notify(message) {
            if (Notification.permission === 'granted') new Notification(message);
            else if (Notification.permission !== 'denied') Notification.requestPermission().then(perm => { if (perm === 'granted') new Notification(message); });
        }

        init();
    </script>
</body>
</html>
